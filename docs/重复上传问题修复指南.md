# 重复上传问题修复指南

## 🔍 问题分析

用户上传一个视频后，出现了5个相同的媒体记录，其中3个没有缩略图。

**原因：**
1. **前端重复提交**：用户可能多次点击上传按钮，或者表单被多次提交
2. **上传过程被中断**：上传过程中出现错误，但部分记录已创建
3. **前端没有防重复提交保护**：上传组件没有防止重复提交的机制

## ✅ 已实施的修复

### 1. 清理重复记录

已创建清理脚本 `auto_cleanup_duplicates.py`，可以：
- 自动识别重复的媒体记录（相同标题）
- 保留最新的有缩略图的记录
- 删除其他重复记录

**使用方法：**
```powershell
python auto_cleanup_duplicates.py
```

### 2. 生成缺失的缩略图

已创建脚本 `generate_thumbnails.py`，可以为没有缩略图的视频生成缩略图。

**使用方法：**
```powershell
python generate_thumbnails.py
```

### 3. 前端防重复提交

已修复 `frontend-vue/src/views/Upload.vue`：

- ✅ 添加 `isSubmitting` 标记，防止重复提交
- ✅ 在上传过程中禁用提交按钮
- ✅ 显示上传状态和进度
- ✅ 添加错误处理和重试机制

**修复内容：**
```typescript
// 防止重复提交的标记
const isSubmitting = ref(false)

async function submit() {
  // 防止重复提交
  if (isSubmitting.value || loading.value) {
    ElMessage.warning('正在上传中，请勿重复提交')
    return
  }
  
  isSubmitting.value = true
  // ... 上传逻辑
}
```

## 🔧 预防措施

### 1. 前端预防

- ✅ 上传按钮在上传过程中自动禁用
- ✅ 添加 `isSubmitting` 标记，防止并发提交
- ✅ 显示明确的上传状态和进度

### 2. 后端预防（可选）

如果需要在后端也添加防重复提交保护，可以在 `files/views/media.py` 中添加：

```python
from django.core.cache import cache

def post(self, request, format=None):
    # 使用用户ID + 文件MD5作为缓存键，防止重复上传
    media_file = request.data.get("media_file")
    if media_file:
        file_content = media_file.read()
        file_md5 = hashlib.md5(file_content).hexdigest()
        cache_key = f"upload_{request.user.id}_{file_md5}"
        
        if cache.get(cache_key):
            return Response(
                {"detail": "该文件正在上传中，请勿重复提交"},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # 设置缓存，5分钟内有效
        cache.set(cache_key, True, 300)
    
    # ... 原有上传逻辑
```

### 3. 数据库约束（可选）

可以添加数据库唯一约束，防止相同文件重复上传：

```python
class Media(models.Model):
    # ... 现有字段
    
    class Meta:
        # 确保同一用户不能上传相同文件名的文件（可选）
        unique_together = [('user', 'title', 'add_date')]
```

## 📋 问题排查步骤

如果再次出现重复上传问题：

1. **检查前端**
   - 打开浏览器开发者工具
   - 查看 Network 标签，检查是否有多次 POST 请求到 `/api/v1/media`
   - 检查是否有 JavaScript 错误

2. **检查后端日志**
   - 查看 Django 服务器日志
   - 查看是否有重复的 `POST /api/v1/media` 请求

3. **检查数据库**
   ```python
   from files.models import Media
   # 查找重复记录
   from collections import Counter
   titles = [m.title for m in Media.objects.all()]
   duplicates = {k: v for k, v in Counter(titles).items() if v > 1}
   ```

4. **清理重复记录**
   ```powershell
   python auto_cleanup_duplicates.py
   ```

## 🎯 最佳实践

1. **上传前验证**
   - 检查文件是否已存在
   - 检查文件大小是否符合限制
   - 检查文件类型是否支持

2. **上传过程中**
   - 显示明确的上传进度
   - 禁用提交按钮
   - 提供取消上传的功能

3. **上传完成后**
   - 显示成功消息
   - 自动跳转到新创建的媒体页面
   - 提供重试失败的选项

## 📝 相关文件

- `frontend-vue/src/views/Upload.vue` - 前端上传组件
- `files/views/media.py` - 后端上传视图
- `files/models/media.py` - 媒体模型
- `auto_cleanup_duplicates.py` - 清理重复记录脚本
- `generate_thumbnails.py` - 生成缩略图脚本

## ⚠️ 注意事项

1. **清理脚本会删除数据**：运行清理脚本前，请确保已备份重要数据
2. **缩略图生成需要时间**：大视频文件的缩略图生成可能需要较长时间
3. **防重复提交仅在前端**：如果需要更严格的保护，建议在后端也添加验证

