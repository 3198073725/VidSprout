# åª’ä½“æ˜¾ç¤ºé—®é¢˜ä¿®å¤æŒ‡å—

## ğŸ” é—®é¢˜åˆ†æ

ä¸Šä¼ çš„è§†é¢‘æˆåŠŸåˆ›å»ºï¼Œä½†åœ¨é¦–é¡µå’Œä¸ªäººä¸»é¡µä¸­ä¸æ˜¾ç¤ºã€‚

**åŸå› ï¼š**
1. `is_reviewed = False` - åª’ä½“éœ€è¦ç®¡ç†å‘˜å®¡æ ¸æ‰èƒ½æ˜¾ç¤º
2. `encoding_status = "pending"` - è§†é¢‘éœ€è¦ç­‰å¾…ç¼–ç å®Œæˆæ‰èƒ½æ˜¾ç¤º
3. `listable = False` - ç”±äºä¸Šè¿°æ¡ä»¶ä¸æ»¡è¶³ï¼Œåª’ä½“è¢«æ ‡è®°ä¸ºä¸å¯åˆ—å‡º

**MediaCMS çš„æ˜¾ç¤ºé€»è¾‘ï¼š**
åª’ä½“è¦å‡ºç°åœ¨åˆ—è¡¨ä¸­ï¼Œå¿…é¡»åŒæ—¶æ»¡è¶³ï¼š
- `state == "public"`
- `encoding_status == "success"`
- `is_reviewed == True`

åªæœ‰åŒæ—¶æ»¡è¶³è¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œ`listable` æ‰ä¼šè¢«è®¾ç½®ä¸º `True`ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå¼€å‘ç¯å¢ƒä¼˜åŒ–ï¼ˆå·²å®æ–½ï¼‰

ä¿®æ”¹äº† `files/models/media.py` çš„ `save()` æ–¹æ³•ï¼š

1. **è‡ªåŠ¨è®¾ç½® `is_reviewed`**ï¼š
   ```python
   # å¦‚æœ MEDIA_IS_REVIEWED = Falseï¼ˆä¸éœ€è¦å®¡æ ¸ï¼‰ï¼Œè‡ªåŠ¨è®¾ç½® is_reviewed = True
   if not getattr(settings, 'MEDIA_IS_REVIEWED', True):
       self.is_reviewed = True
   ```

2. **å¼€å‘ç¯å¢ƒå…è®¸ `pending` çŠ¶æ€çš„è§†é¢‘æ˜¾ç¤º**ï¼š
   ```python
   # å¼€å‘ç¯å¢ƒï¼šå¦‚æœ MEDIA_IS_REVIEWED = Falseï¼Œå…è®¸è§†é¢‘åœ¨ç¼–ç å®Œæˆå‰æ˜¾ç¤º
   if not getattr(settings, 'MEDIA_IS_REVIEWED', True):
       if self.state == "public" and self.is_reviewed is True:
           # å…è®¸ pending çŠ¶æ€çš„è§†é¢‘ä¹Ÿæ˜¾ç¤ºï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒï¼‰
           if self.encoding_status in ["success", "pending"]:
               self.listable = True
   ```

**æ•ˆæœï¼š**
- åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ˆ`MEDIA_IS_REVIEWED = False`ï¼‰ï¼Œæ–°ä¸Šä¼ çš„è§†é¢‘å¯ä»¥ç«‹å³æ˜¾ç¤º
- å³ä½¿è§†é¢‘è¿˜åœ¨ç¼–ç ä¸­ï¼ˆ`encoding_status = "pending"`ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¾ç¤º
- å›¾ç‰‡å’ŒéŸ³é¢‘æ–‡ä»¶ï¼ˆ`encoding_status` ç«‹å³ä¸º `success`ï¼‰å¯ä»¥ç«‹å³æ˜¾ç¤º

### æ–¹æ¡ˆ 2ï¼šç­‰å¾…ç¼–ç å®Œæˆï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè§†é¢‘éœ€è¦ç­‰å¾…ç¼–ç å®Œæˆï¼š

1. **å¯åŠ¨ Celery worker**ï¼š
   ```powershell
   celery -A cms worker -l info
   ```

2. **ç­‰å¾…ç¼–ç å®Œæˆ**ï¼š
   - è§†é¢‘ä¸Šä¼ åï¼ŒCelery worker ä¼šè‡ªåŠ¨å¼€å§‹ç¼–ç 
   - ç¼–ç å®Œæˆåï¼Œ`encoding_status` ä¼šå˜ä¸º `"success"`
   - æ­¤æ—¶åª’ä½“ä¼šè‡ªåŠ¨å˜ä¸º `listable = True`

### æ–¹æ¡ˆ 3ï¼šç¦ç”¨è§†é¢‘è½¬ç ï¼ˆä»…ç”¨äºå¿«é€Ÿæµ‹è¯•ï¼‰

åœ¨ `cms/local_settings.py` ä¸­æ·»åŠ ï¼š
```python
DO_NOT_TRANSCODE_VIDEO = True
```

**æ•ˆæœï¼š**
- è§†é¢‘ä¸ä¼šè¿›è¡Œç¼–ç ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ–‡ä»¶
- `encoding_status` ä¼šç«‹å³è®¾ç½®ä¸º `"success"`
- è§†é¢‘å¯ä»¥ç«‹å³æ˜¾ç¤º

**æ³¨æ„ï¼š** è¿™ä»…ç”¨äºå¼€å‘æµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒä¸æ¨èã€‚

## ğŸ”§ ä¿®å¤ç°æœ‰åª’ä½“

å¦‚æœå·²æœ‰åª’ä½“æœªæ˜¾ç¤ºï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ›´æ–°ï¼š

```python
from files.models import Media
from django.conf import settings

for m in Media.objects.all():
    if not m.is_reviewed and not getattr(settings, 'MEDIA_IS_REVIEWED', True):
        m.is_reviewed = True
        m.save()
```

## ğŸ“‹ éªŒè¯ä¿®å¤

1. **æ£€æŸ¥åª’ä½“çŠ¶æ€**ï¼š
   ```python
   from files.models import Media
   m = Media.objects.latest('add_date')
   print(f'State: {m.state}')
   print(f'Encoding: {m.encoding_status}')
   print(f'Reviewed: {m.is_reviewed}')
   print(f'Listable: {m.listable}')
   ```

2. **æ£€æŸ¥ API å“åº”**ï¼š
   - è®¿é—®ï¼š`http://localhost:8000/api/v1/media`
   - åº”è¯¥èƒ½çœ‹åˆ°ä¸Šä¼ çš„åª’ä½“

3. **æ£€æŸ¥å‰ç«¯æ˜¾ç¤º**ï¼š
   - åˆ·æ–°é¦–é¡µ
   - åˆ·æ–°ä¸ªäººä¸»é¡µ
   - åº”è¯¥èƒ½çœ‹åˆ°ä¸Šä¼ çš„åª’ä½“

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ**ï¼š
   - å¼€å‘ç¯å¢ƒï¼šå…è®¸ `pending` çŠ¶æ€çš„è§†é¢‘æ˜¾ç¤º
   - ç”Ÿäº§ç¯å¢ƒï¼šä¸¥æ ¼è¦æ±‚ `encoding_status == "success"`

2. **è§†é¢‘ç¼–ç **ï¼š
   - è§†é¢‘ç¼–ç éœ€è¦æ—¶é—´ï¼Œå–å†³äºè§†é¢‘å¤§å°å’Œå¤æ‚åº¦
   - ç¡®ä¿ Celery worker æ­£åœ¨è¿è¡Œ
   - ç¡®ä¿ Redis è¿æ¥æ­£å¸¸

3. **åª’ä½“çŠ¶æ€**ï¼š
   - `state`ï¼š`"public"`ã€`"private"` æˆ– `"unlisted"`
   - `encoding_status`ï¼š`"pending"`ã€`"running"`ã€`"success"` æˆ– `"fail"`
   - `is_reviewed`ï¼šæ˜¯å¦éœ€è¦ç®¡ç†å‘˜å®¡æ ¸
   - `listable`ï¼šæ˜¯å¦å¯ä»¥åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤º

## ğŸ¯ æ€»ç»“

ä¿®å¤åï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ï¼š
- âœ… æ–°ä¸Šä¼ çš„åª’ä½“è‡ªåŠ¨è®¾ç½® `is_reviewed = True`
- âœ… `pending` çŠ¶æ€çš„è§†é¢‘å¯ä»¥æ˜¾ç¤º
- âœ… å›¾ç‰‡å’ŒéŸ³é¢‘å¯ä»¥ç«‹å³æ˜¾ç¤º
- âœ… è§†é¢‘ç¼–ç å®Œæˆåï¼ŒçŠ¶æ€ä¼šè‡ªåŠ¨æ›´æ–°ä¸º `success`

ç°åœ¨ä¸Šä¼ çš„åª’ä½“åº”è¯¥å¯ä»¥æ­£å¸¸æ˜¾ç¤ºåœ¨é¦–é¡µå’Œä¸ªäººä¸»é¡µäº†ï¼ğŸ‰

