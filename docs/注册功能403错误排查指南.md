# MediaCMS æ³¨å†ŒåŠŸèƒ½ 403 é”™è¯¯æ’æŸ¥æŒ‡å—

## ğŸ” é—®é¢˜åˆ†æ

ç”¨æˆ·æ³¨å†Œæ—¶æ”¶åˆ° **403 Forbidden** é”™è¯¯ï¼Œæç¤º"æ³¨å†ŒåŠŸèƒ½éœ€è¦ç®¡ç†å‘˜å¼€å¯"ã€‚

### å¯èƒ½çš„åŸå› 

1. **CSRF_TRUSTED_ORIGINS æœªé…ç½®**ï¼ˆæœ€å¸¸è§ï¼ï¼‰
   - Django çš„ CSRF ä¸­é—´ä»¶ä¼šæ£€æŸ¥è¯·æ±‚çš„ `Origin` å¤´
   - å¦‚æœ `Origin` ä¸åœ¨ `CSRF_TRUSTED_ORIGINS` ä¸­ï¼Œä¼šè¿”å› 403
   - é”™è¯¯ä¿¡æ¯ï¼š`Forbidden (Origin checking failed - http://localhost:8088 does not match any trusted origins.)`

2. **CSRF Token ç¼ºå¤±**
   - Django çš„ CSRF ä¸­é—´ä»¶ä¼šæ‹’ç»æ²¡æœ‰ CSRF token çš„ POST è¯·æ±‚
   - è¿”å› 403 Forbidden

3. **USERS_CAN_SELF_REGISTER è®¾ç½®**
   - å¦‚æœè®¾ç½®ä¸º `False`ï¼Œæ³¨å†Œä¼šè¢«å…³é—­
   - å½“å‰è®¾ç½®ï¼š`USERS_CAN_SELF_REGISTER = True` âœ…

4. **CORS é…ç½®é—®é¢˜**
   - å¦‚æœ CORS é…ç½®ä¸æ­£ç¡®ï¼Œå¯èƒ½å¯¼è‡´ cookie æ— æ³•å‘é€

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ï¼šCSRF Token ç¼ºå¤±

**åŸå› ï¼š**
- `createUser()` å‡½æ•°ç›´æ¥è°ƒç”¨ `/accounts/signup/` æ—¶æ²¡æœ‰åŒ…å« CSRF token
- Django çš„ CSRF ä¸­é—´ä»¶æ‹’ç»è¯·æ±‚ï¼Œè¿”å› 403

**ä¿®å¤ï¼š**
1. åœ¨å‘é€æ³¨å†Œè¯·æ±‚å‰ï¼Œå…ˆè®¿é—® `/accounts/signup/` GET ç«¯ç‚¹è·å– CSRF cookie
2. ä» cookie ä¸­æå– CSRF token
3. åœ¨ POST è¯·æ±‚çš„ `X-CSRFToken` å¤´ä¸­åŒ…å« CSRF token
4. ç¡®ä¿ `withCredentials: true` ä»¥å‘é€ cookies

---

## ğŸ”§ é…ç½®æ£€æŸ¥æ¸…å•

### 1. Django è®¾ç½®æ£€æŸ¥

```python
# cms/local_settings.py æˆ– cms/settings.py
USERS_CAN_SELF_REGISTER = True  # âœ… å¿…é¡»ä¸º True

# âœ… é‡è¦ï¼šå¿…é¡»é…ç½® CSRF_TRUSTED_ORIGINSï¼
CSRF_TRUSTED_ORIGINS = [
    "http://localhost:8088",  # Vite å¼€å‘æœåŠ¡å™¨ç«¯å£
    "http://127.0.0.1:8088",
    "http://localhost:8000",   # Django å¼€å‘æœåŠ¡å™¨
    "http://127.0.0.1:8000",
]

# âœ… CORS é…ç½®
CORS_ALLOWED_ORIGINS = [
    "http://localhost:8088",
    "http://127.0.0.1:8088",
]
CORS_ALLOW_CREDENTIALS = True  # âœ… å¿…é¡»ä¸º Trueï¼ˆç”¨äºå‘é€ cookiesï¼‰
```

**éªŒè¯æ–¹æ³•ï¼š**
```bash
python manage.py shell -c "from django.conf import settings; print('USERS_CAN_SELF_REGISTER:', settings.USERS_CAN_SELF_REGISTER); print('CSRF_TRUSTED_ORIGINS:', getattr(settings, 'CSRF_TRUSTED_ORIGINS', 'NOT SET'))"
```

### 2. CSRF ä¸­é—´ä»¶æ£€æŸ¥

```python
# cms/settings.py
MIDDLEWARE = [
    ...
    'django.middleware.csrf.CsrfViewMiddleware',  # âœ… å¿…é¡»å­˜åœ¨
    ...
]
```

### 3. CORS é…ç½®æ£€æŸ¥

```python
# cms/local_settings.py
CORS_ALLOWED_ORIGINS = [
    "http://localhost:8080",
    "http://127.0.0.1:8080",
]
CORS_ALLOW_CREDENTIALS = True  # âœ… å¿…é¡»ä¸º Trueï¼ˆç”¨äºå‘é€ cookiesï¼‰
```

### 4. å‰ç«¯ç¯å¢ƒå˜é‡æ£€æŸ¥

```bash
# frontend-vue/.env.development
VITE_BACKEND_URL=http://localhost:8000  # âœ… å¿…é¡»æ­£ç¡®
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. **æ£€æŸ¥è®¾ç½®ï¼š**
   ```bash
   python manage.py shell -c "from django.conf import settings; print('USERS_CAN_SELF_REGISTER:', settings.USERS_CAN_SELF_REGISTER)"
   ```

2. **æµ‹è¯•æ³¨å†Œç«¯ç‚¹ï¼š**
   ```bash
   curl -X GET http://localhost:8000/accounts/signup/ \
     -H "Cookie: csrftoken=test" \
     -v
   ```

3. **æµ‹è¯•æ³¨å†Œï¼ˆå¸¦ CSRF tokenï¼‰ï¼š**
   ```bash
   # å…ˆè·å– CSRF token
   CSRF_TOKEN=$(curl -s -c cookies.txt http://localhost:8000/accounts/signup/ | grep csrftoken | awk '{print $7}')
   
   # ä½¿ç”¨ CSRF token æ³¨å†Œ
   curl -X POST http://localhost:8000/accounts/signup/ \
     -b cookies.txt \
     -H "X-CSRFToken: $CSRF_TOKEN" \
     -F "username=testuser" \
     -F "password1=testpass123" \
     -F "password2=testpass123" \
     -F "email=test@example.com"
   ```

---

## ğŸ“ å‰ç«¯ä»£ç ä¿®å¤

### ä¿®å¤å‰çš„é—®é¢˜

```typescript
// âŒ ç¼ºå°‘ CSRF token
return axios.post('/accounts/signup/', formData, {
  baseURL: backendURL,
  withCredentials: true,
  headers: {
    'Content-Type': 'multipart/form-data'
  }
})
```

### ä¿®å¤åçš„ä»£ç 

```typescript
// âœ… åŒ…å« CSRF token
// 1. å…ˆè·å– CSRF cookie
await axios.get('/accounts/signup/', {
  baseURL: backendURL,
  withCredentials: true
})

// 2. ä» cookie ä¸­æå– CSRF token
const csrfToken = getCookie('csrftoken')

// 3. åœ¨ POST è¯·æ±‚ä¸­åŒ…å« CSRF token
return axios.post('/accounts/signup/', formData, {
  baseURL: backendURL,
  withCredentials: true,
  headers: {
    'Content-Type': 'multipart/form-data',
    'X-CSRFToken': csrfToken  // âœ… æ·»åŠ  CSRF token
  }
})
```

---

## âš ï¸ å¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šCSRF_TRUSTED_ORIGINS æœªé…ç½®
- **ç—‡çŠ¶ï¼š** `403 Forbidden (Origin checking failed - http://localhost:8088 does not match any trusted origins.)`
- **åŸå› ï¼š** Django CSRF ä¸­é—´ä»¶æ£€æŸ¥ Origin å¤´ï¼Œä½† `CSRF_TRUSTED_ORIGINS` ä¸­æ²¡æœ‰é…ç½®å‰ç«¯åœ°å€
- **è§£å†³ï¼š** åœ¨ `local_settings.py` ä¸­æ·»åŠ  `CSRF_TRUSTED_ORIGINS`ï¼ŒåŒ…å«å‰ç«¯åœ°å€ï¼ˆåè®®+ä¸»æœº+ç«¯å£ï¼‰

### é”™è¯¯ 2ï¼šCSRF token ç¼ºå¤±
- **ç—‡çŠ¶ï¼š** 403 Forbidden
- **åŸå› ï¼š** POST è¯·æ±‚æ²¡æœ‰åŒ…å« CSRF token
- **è§£å†³ï¼š** åœ¨è¯·æ±‚å‰è·å– CSRF cookieï¼Œå¹¶åœ¨è¯·æ±‚å¤´ä¸­åŒ…å« token

### é”™è¯¯ 3ï¼šCORS é…ç½®é”™è¯¯
- **ç—‡çŠ¶ï¼š** 403 Forbidden æˆ– CORS é”™è¯¯
- **åŸå› ï¼š** `CORS_ALLOW_CREDENTIALS = False` æˆ–å‰ç«¯ origin ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­
- **è§£å†³ï¼š** ç¡®ä¿ `CORS_ALLOW_CREDENTIALS = True` å¹¶æ­£ç¡®é…ç½® `CORS_ALLOWED_ORIGINS`

### é”™è¯¯ 4ï¼šUSERS_CAN_SELF_REGISTER = False
- **ç—‡çŠ¶ï¼š** 403 Forbiddenï¼Œæç¤ºæ³¨å†Œå·²å…³é—­
- **åŸå› ï¼š** è®¾ç½®è¢«ç¦ç”¨
- **è§£å†³ï¼š** åœ¨ `local_settings.py` ä¸­è®¾ç½® `USERS_CAN_SELF_REGISTER = True`

---

## ğŸ¯ æ€»ç»“

**ä¸»è¦é—®é¢˜ï¼š** `CSRF_TRUSTED_ORIGINS` æœªé…ç½®å¯¼è‡´ 403 Forbidden

**å·²ä¿®å¤ï¼š**
1. âœ… æ·»åŠ  `CSRF_TRUSTED_ORIGINS` é…ç½®ï¼ŒåŒ…å«å‰ç«¯åœ°å€ï¼ˆ`http://localhost:8088`ï¼‰
2. âœ… æ›´æ–° `CORS_ALLOWED_ORIGINS` åŒ…å«æ­£ç¡®çš„ç«¯å£ï¼ˆ8088ï¼‰
3. âœ… `createUser()` å‡½æ•°ç°åœ¨ä¼šå…ˆè·å– CSRF token
4. âœ… åœ¨ POST è¯·æ±‚ä¸­åŒ…å« CSRF token
5. âœ… ç¡®ä¿ `withCredentials: true` ä»¥å‘é€ cookies

**é…ç½®éªŒè¯ï¼š**
- âœ… `USERS_CAN_SELF_REGISTER = True`
- âœ… `CSRF_TRUSTED_ORIGINS` åŒ…å«å‰ç«¯åœ°å€
- âœ… CSRF ä¸­é—´ä»¶å·²å¯ç”¨
- âœ… CORS é…ç½®æ­£ç¡®ï¼ˆ`CORS_ALLOW_CREDENTIALS = True`ï¼‰

**é‡è¦æç¤ºï¼š**
- `CSRF_TRUSTED_ORIGINS` å¿…é¡»åŒ…å«**å®Œæ•´çš„ URL**ï¼ˆåè®®+ä¸»æœº+ç«¯å£ï¼‰ï¼Œä¾‹å¦‚ï¼š`http://localhost:8088`
- å¦‚æœå‰ç«¯è¿è¡Œåœ¨ä¸åŒçš„ç«¯å£ï¼Œå¿…é¡»æ›´æ–° `CSRF_TRUSTED_ORIGINS` å’Œ `CORS_ALLOWED_ORIGINS`
- ä¿®æ”¹é…ç½®åéœ€è¦**é‡å¯ Django æœåŠ¡å™¨**æ‰èƒ½ç”Ÿæ•ˆ

ç°åœ¨æ³¨å†ŒåŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼ğŸ‰

